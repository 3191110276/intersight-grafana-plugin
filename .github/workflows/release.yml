name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0, 1.1.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

jobs:
  validate-version:
    name: Validate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}
      tag: ${{ steps.validate.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate semantic version format
        id: validate
        run: |
          VERSION="${{ github.event.inputs.version }}"

          # Validate semantic version format (MAJOR.MINOR.PATCH)
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Error: Invalid version format. Expected MAJOR.MINOR.PATCH (e.g., 1.0.0)"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "Version format validated: $VERSION"

      - name: Verify version in plugin.json
        run: |
          PLUGIN_VERSION=$(node -p "require('./src/plugin.json').version")
          INPUT_VERSION="${{ steps.validate.outputs.version }}"

          if [ "$PLUGIN_VERSION" != "$INPUT_VERSION" ]; then
            echo "Error: Version mismatch!"
            echo "  Input version: $INPUT_VERSION"
            echo "  src/plugin.json version: $PLUGIN_VERSION"
            echo ""
            echo "Please update src/plugin.json to version $INPUT_VERSION before releasing"
            exit 1
          fi

          echo "âœ“ src/plugin.json version matches: $PLUGIN_VERSION"

      - name: Verify version in package.json
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          INPUT_VERSION="${{ steps.validate.outputs.version }}"

          if [ "$PACKAGE_VERSION" != "$INPUT_VERSION" ]; then
            echo "Error: Version mismatch!"
            echo "  Input version: $INPUT_VERSION"
            echo "  package.json version: $PACKAGE_VERSION"
            echo ""
            echo "Please update package.json to version $INPUT_VERSION before releasing"
            exit 1
          fi

          echo "âœ“ package.json version matches: $PACKAGE_VERSION"

      - name: Check if tag already exists
        run: |
          TAG="${{ steps.validate.outputs.tag }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Error: Git tag $TAG already exists"
            echo "This version has already been released"
            exit 1
          fi
          echo "âœ“ Tag $TAG does not exist yet"

  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    needs: validate-version
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run type checking
        run: npm run typecheck

      - name: Build, package, and validate
        run: npm run package-and-validate

      - name: Verify package file exists
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          PACKAGE_FILE="../cisco-intersight-app-$VERSION.zip"

          if [ ! -f "$PACKAGE_FILE" ]; then
            echo "Error: Package file not found at $PACKAGE_FILE"
            exit 1
          fi

          echo "âœ“ Package file created: $PACKAGE_FILE"
          ls -lh "$PACKAGE_FILE"

      - name: Extract release notes from CHANGELOG
        id: changelog
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"

          # Extract release notes for this version from CHANGELOG.md
          if [ -f "CHANGELOG.md" ]; then
            # Try to extract section between ## [VERSION] and next ## header
            NOTES=$(awk "/## \[$VERSION\]/,/## \[/ {if (/## \[$VERSION\]/) next; if (/## \[/) exit; print}" CHANGELOG.md | sed '/^$/d')

            if [ -z "$NOTES" ]; then
              echo "Warning: No release notes found in CHANGELOG.md for version $VERSION"
              NOTES="Release $VERSION"
            fi
          else
            echo "Warning: CHANGELOG.md not found"
            NOTES="Release $VERSION"
          fi

          # Save to output file for multiline support
          echo "$NOTES" > release-notes.txt
          echo "Release notes extracted"

      - name: Create and push tag
        run: |
          TAG="${{ needs.validate-version.outputs.tag }}"
          VERSION="${{ needs.validate-version.outputs.version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "$TAG" -m "Release $VERSION"
          git push origin "$TAG"

          echo "âœ“ Created and pushed tag: $TAG"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate-version.outputs.tag }}
          name: Release ${{ needs.validate-version.outputs.version }}
          body_path: release-notes.txt
          files: ../cisco-intersight-app-${{ needs.validate-version.outputs.version }}.zip
          prerelease: ${{ github.event.inputs.prerelease }}
          generate_release_notes: true

      - name: Release summary
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          TAG="${{ needs.validate-version.outputs.tag }}"
          PRERELEASE="${{ github.event.inputs.prerelease }}"

          echo "ðŸŽ‰ Release created successfully!"
          echo ""
          echo "Version: $VERSION"
          echo "Tag: $TAG"
          echo "Pre-release: $PRERELEASE"
          echo "Package: cisco-intersight-app-$VERSION.zip"
          echo ""
          echo "View release at: ${{ github.server_url }}/${{ github.repository }}/releases/tag/$TAG"
